on:
    pull_request:
      branches:
        - "*"
  
jobs:
    changed_files:
      runs-on: ubuntu-latest
      outputs:
        new_study_dirs: ${{ steps.new-dirs.outputs.NEW_DIR_LOCATIONS }}
      steps:
        - name: Get New Directories Added
          id: changed-files-dir-names
          uses: tj-actions/changed-files@v38
          with:
            dir_names: "true"
        - name: Extract Parent Directory Names of New Studies
          id: new-dirs
          shell: bash
          run: |
            echo "NEW_DIR_LOCATIONS=$( echo ${{ steps.changed-files-dir-names.outputs.added_files }} | sed 's/[^ ]*\/case_lists[^ ]*//g' )" >> $GITHUB_OUTPUT
        
    preview:
      needs: changed_files
      runs-on: ubuntu-latest
      container: docker.io/okteto/okteto:2.19.1
      steps:
        - name: Install Git LFS
          run: apk update && apk add git-lfs
  
        - name: Checkout Datahub Repository
          uses: actions/checkout@v4
          with:
            lfs: true
            sparse-checkout-cone-mode: false
            sparse-checkout: |
              preview/*
              public/*
              !public/ccle_broad_2019
              !public/brca_tcga_pan_can_atlas_2018
              !public/brca_metabric
              !public/brca_tcga
              !public/brca_tcga_pub2015
              !public/cellline_ccle_broad
              !public/blca_tcga_pan_can_atlas_2018
              !public/brca_tcga_pub 
              !public/blca_tcga_pub_2017 
              !public/coadread_tcga 
              !public/blca_tcga 
              !public/cesc_tcga_pan_can_atlas_2018 
              !public/aml_ohsu_2018 
              !public/aml_ohsu_2022 
              !public/coadread_tcga_pub 
              !public/all_phase2_target_2018_pub 
              !public/coadread_tcga_pan_can_atlas_2018 
              !public/cesc_tcga
              !public/coad_cptac_2019
              !public/blca_msk_tcga_2020
              !public/brain_cptac_2020
              !public/brca_mbcproject_2022
              !public/brca_mbcproject_wagle_2017
              !public/brca_cptac_2020
              !public/blca_tcga_pub
              !public/angs_painter_2020
              !public/acc_tcga_pan_can_atlas_2018
              !public/cellline_nci60
              !public/acc_tcga
              !public/aml_target_2018_pub
              !public/coad_silu_2022
              !public/bcc_unige_2016
              !public/acc_2019
              !public/brca_smc_2018
              !public/chol_tcga_pan_can_atlas_2018
              !public/blca_mskcc_solit_2012
              !public/blca_bcan_hcrn_2022
              !public/coadread_genentech
              !public/cll_broad_2015
              !public/chol_tcga
              !public/ccrcc_utokyo_2013
              !public/prad_su2c_2015
              !public/blca_cornell_2016

        - name: Copy Files to Study Directory
          shell: bash
          run: |
            for dir in ${{ needs.changed_files.outputs.new_study_dirs }}; do
              study_name=$( cut -d "/" -f2- <<< ${dir}) # remove public/ from dir name
              cp -v -R ${dir} preview/cbioportal-docker-compose/study/${study_name}
            done
  
        - name: Context
          uses: okteto/context@latest
          with:
            url: ${{secrets.OKTETO_URL}}
            token: ${{ secrets.OKTETO_TOKEN }}
  
        - name: Okteto Build to Import Studies
          working-directory: preview/cbioportal-docker-compose
          run: |
            okteto build --no-cache -t okteto.dev/cbioportal-docker-compose-cbioportal:okteto-with-volume-mounts cbioportal
  
        - name: Deploy preview environment
          uses: okteto/deploy-preview@latest
          env:
           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            name: pr-${{ github.event.number }}-justinjao
            file: preview/cbioportal-docker-compose/docker-compose.yml
            timeout: 15m
      
        - name: Wait For Response
          uses: nev7n/wait_for_response@v1.0.1
          with:
            url: 'https://cbioportal-pr-${{ github.event.number }}-justinjao.cloud.okteto.net/'
            responseCode: 200
            timeout: 600000 # 10 minutes
            interval: 30000 # 30 seconds
  
        - name: "Activate Namespace"
          uses: okteto/namespace@latest
          with:
            namespace: pr-${{github.event.number}}-justinjao
  
        - name: Kubectl test
          shell: bash
          run: |
            okteto kubeconfig
            for dir in ${{ needs.changed_files.outputs.new_study_dirs }}; do
              study_name=$( cut -d "/" -f2- <<< ${dir}) # remove public/ from dir name
              kubectl exec -it deployment/cbioportal -- metaImport.py -u http://localhost:8080 -s study/${study_name} -o
            done
  
